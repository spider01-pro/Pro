<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Drive</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{box-sizing:border-box;font-family:Roboto,Arial,sans-serif}
        body{margin:0;padding:20px;background:#f8f9fa}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .drive-title{font-size:24px;color:#1a73e8;font-weight:500}
        .search-box{padding:10px 15px;width:420px;border-radius:8px;border:1px solid #dadce0}
        .main-container{display:flex;gap:30px}
        .sidebar{width:260px}
        .sidebar-section{margin-bottom:20px}
        .sidebar-section ul{list-style:none;padding:0;margin:0}
        .sidebar-section li{padding:10px 0;display:flex;align-items:center;cursor:pointer}
        .sidebar-section li i{margin-right:12px;color:#5f6368;width:20px;text-align:center}
        .content{flex:1;background:#fff;padding:20px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.08)}
        .upload-container{display:flex;gap:10px;align-items:center;margin-bottom:12px}
        .upload-btn{background:#1a73e8;color:#fff;padding:10px 14px;border-radius:6px;border:none;cursor:pointer;display:flex;align-items:center;gap:8px}
        .file-table{width:100%;border-collapse:collapse}
        .file-table th,.file-table td{padding:12px 10px;border-bottom:1px solid #e8eaed;text-align:left}
        .file-table th{background:#f8f9fa;color:#5f6368;font-weight:600}
        .file-row{cursor:default}
        .file-row:hover{background:#f8f9fa}
        .file-icon{margin-right:10px;color:#5f6368}
        .upload-panel{position:fixed;right:20px;bottom:20px;width:320px;z-index:200}
        .upload-card{background:#fff;padding:8px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.12);margin-bottom:10px;overflow:hidden}
        .progress-bar{height:8px;background:#eee;border-radius:8px;overflow:hidden;margin:8px 0}
        .progress-inner{height:100%;background:#1a73e8;width:0;transition:width .2s linear}
        .ctx-menu{position:fixed;display:none;z-index:1000;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 6px 20px rgba(0,0,0,0.15);min-width:160px;padding:6px 0}
        .ctx-menu button{display:block;width:100%;border:none;background:none;padding:10px 14px;text-align:left;cursor:pointer}
        .ctx-menu button:hover{background:#f1f8fe}
        .modal{display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1200;align-items:center;justify-content:center}
        .modal .modal-content{background:#fff;padding:16px;border-radius:8px;width:420px;max-width:95%}
        .modal input[type="text"]{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}
        .small{font-size:13px;color:#5f6368}
    </style>
</head>
<body>
    <div class="header">
        <div style="display:flex;gap:12px;align-items:center">
            <span class="drive-title">Drive</span>
            <input class="search-box" placeholder="Search in Drive">
        </div>
        <div id="breadcrumbs" class="small"></div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-section">
                <ul>
                    <li style="background:#e8f0fe;border-radius:0 12px 12px 0;color:#1a73e8;font-weight:600"><i class="fas fa-hard-drive"></i> My Drive</li>
                    <li onclick="openTrash()"><i class="fas fa-trash"></i> Trash</li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>Storage</h3>
                <div id="storage-text">{{ storage_used }} MB used</div>
                <div id="disk-text" class="small" style="margin-top:6px"></div>
            </div>
        </div>

        <div class="content">
            <div class="upload-container">
                <div class="dropdown" id="new-dropdown">
                    <button class="upload-btn" onclick="toggleDropdown()"><i class="fas fa-plus"></i> New</button>
                    <div id="new-menu" class="small" style="display:none;position:absolute;background:#fff;border:1px solid #ddd;padding:8px;border-radius:6px;margin-top:8px;left:20px">
                        <div style="padding:6px 8px;cursor:pointer" onclick="triggerFile()">Upload File</div>
                        <div style="padding:6px 8px;cursor:pointer" onclick="triggerFolder()">Upload Folder</div>
                        <div style="padding:6px 8px;cursor:pointer" onclick="createFolder()">Create New Folder</div>
                    </div>
                </div>

                <form id="upload-form" enctype="multipart/form-data" style="display:none;">
                    <input id="file-input" type="file" name="file">
                    <input id="folder-input" type="file" name="file" webkitdirectory directory multiple>
                </form>
                <div style="margin-left:8px">
                    <button class="upload-btn" onclick="triggerFile()"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
                </div>
            </div>

            <table class="file-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Date modified</th>
                        <th>File size</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="file-list">
                    {% set cp = current_path %}
                    {% for file in files %}
                    <tr class="file-row" data-name="{{ file.name }}" data-type="{{ file.type }}" data-path="{{ cp }}">
                        <td onclick="openItem('{{ file.name|e }}','{{ file.type }}','{{ cp|e }}')">
                            {% if file.type == 'Folder' %}
                            <i class="fas fa-folder file-icon"></i>
                            {% elif file.type == 'Image' %}
                            <i class="fas fa-file-image file-icon"></i>
                            {% elif file.type == 'Video' %}
                            <i class="fas fa-file-video file-icon"></i>
                            {% else %}
                            <i class="fas fa-file-alt file-icon"></i>
                            {% endif %}
                            <span class="file-link">{{ file.name }}</span>
                        </td>
                        <td>{{ file.modified }}</td>
                        <td>{{ file.size }}</td>
                        <td>
                            {% if file.type != 'Folder' %}
                                <button onclick="downloadFile('{{ (cp + '/' if cp else '') + file.name }}')" class="small">Download</button>
                            {% else %}
                                <span class="small">Folder</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- context menu -->
    <div id="ctx-menu" class="ctx-menu" role="menu" aria-hidden="true">
        <button id="ctx-preview">Preview</button>
        <button id="ctx-rename">Rename</button>
        <button id="ctx-delete">Delete</button>
        <button id="ctx-info">File information</button>
        <button id="ctx-copy">Copy to...</button>
        <button id="ctx-move">Move to...</button>
    </div>

    <!-- modals -->
    <div id="rename-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center"><strong>Rename</strong><button onclick="closeModal('rename-modal')">&times;</button></div>
            <div style="margin-top:8px">
                <input id="rename-input" type="text" placeholder="New name">
                <div style="text-align:right;margin-top:10px"><button class="upload-btn" onclick="doRename()">Rename</button></div>
            </div>
        </div>
    </div>

    <div id="info-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center"><strong>File information</strong><button onclick="closeModal('info-modal')">&times;</button></div>
            <div id="info-body" style="margin-top:10px"></div>
            <div style="text-align:right;margin-top:12px"><button class="upload-btn" onclick="closeModal('info-modal')">Close</button></div>
        </div>
    </div>

    <!-- upload notifications -->
    <div class="upload-panel" id="upload-panel" aria-live="polite"></div>

<script>
/* ---------- Helpers and state ---------- */
const uploadPanel = document.getElementById('upload-panel');
const ctx = document.getElementById('ctx-menu');
let currentItem = null; // {name, type, path}

/* ---------- Breadcrumbs ---------- */
const currentPath = "{{ current_path }}";
(function renderBreadcrumbs(){
    const el = document.getElementById('breadcrumbs');
    if(!currentPath) { el.textContent = 'Home'; return; }
    const parts = currentPath.split('/');
    let html = '<a href="/">Home</a>';
    let acc = '';
    parts.forEach((p,i)=>{
        acc += (i===0? '' : '/') + encodeURIComponent(p);
        html += ' / <a href="/?path=' + acc + '">' + p + '</a>';
    });
    el.innerHTML = html;
})();

/* ---------- Diskspace update ---------- */
function updateDisk(){ fetch('/diskspace').then(r=>r.json()).then(d=>{ document.getElementById('disk-text').textContent = `Free: ${d.free_gb} GB (Used: ${d.used_gb} GB of ${d.total_gb} GB)`; }); }
updateDisk(); setInterval(updateDisk, 60*1000);

/* ---------- New dropdown ---------- */
function toggleDropdown(){
    const md = document.getElementById('new-menu');
    md.style.display = md.style.display === 'none' ? 'block' : 'none';
}
document.addEventListener('click', e => { if(!e.target.closest('#new-dropdown')) document.getElementById('new-menu').style.display='none'; });

/* ---------- File/folder navigation ---------- */
function openItem(name, type, path){
    const base = path ? path + '/' + name : name;
    if(type === 'Folder'){
        // navigate into folder
        const enc = encodeURIComponent((path ? path + '/' : '') + name);
        window.location.href = '/?path=' + enc;
    } else {
        // preview file
        const p = (path ? path + '/' : '') + name;
        window.location.href = '/preview/' + encodeURIComponent(p);
    }
}

/* ---------- Upload inputs ---------- */
function triggerFile(){ document.getElementById('file-input').click(); }
function triggerFolder(){ document.getElementById('folder-input').click(); }
document.getElementById('file-input').addEventListener('change', function(){ if(this.files.length) uploadFiles(this.files); this.value=''; });
document.getElementById('folder-input').addEventListener('change', function(){ if(this.files.length) uploadFiles(this.files); this.value=''; });

/* ---------- Upload per-file XHR (progress + cancel) ---------- */
const activeXhrs = {};
function createUploadCard(id, name){
    const card = document.createElement('div'); card.className='upload-card'; card.id='upload-card-'+id;
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${name}</div><button id="cancel-${id}" style="background:none;border:none;cursor:pointer">&times;</button></div><div class="progress-bar"><div id="progress-${id}" class="progress-inner"></div></div><div id="status-${id}" class="small">Starting...</div>`;
    uploadPanel.prepend(card);
    document.getElementById('cancel-'+id).addEventListener('click', ()=> {
        if(activeXhrs[id]) activeXhrs[id].abort();
        const el = document.getElementById('upload-card-'+id); if(el) el.remove();
        delete activeXhrs[id];
    });
}
function uploadFiles(files){
    // files: FileList
    Array.from(files).forEach(file => {
        const rel = file.webkitRelativePath || file.relativePath || file.name;
        startUpload(file, rel);
    });
}
function startUpload(file, uploadName){
    const id = `${Date.now()}-${Math.floor(Math.random()*10000)}`;
    createUploadCard(id, uploadName);
    const xhr = new XMLHttpRequest();
    activeXhrs[id] = xhr;
    xhr.upload.addEventListener('progress', e=>{
        const pct = e.lengthComputable ? Math.round((e.loaded/e.total)*100) : 0;
        const el = document.getElementById('progress-'+id);
        if(el) el.style.width = pct + '%';
        const status = document.getElementById('status-'+id);
        if(status) status.textContent = `${pct}% — ${formatBytes(e.loaded)} / ${formatBytes(e.total)}`;
    });
    xhr.onreadystatechange = function(){
        if(xhr.readyState === 4){
            const status = document.getElementById('status-'+id);
            if(xhr.status >=200 && xhr.status <300){
                if(status) status.textContent = 'Uploaded';
                setTimeout(()=>{ const c = document.getElementById('upload-card-'+id); if(c) c.remove(); location.reload(); }, 800);
            } else {
                if(status) status.textContent = 'Upload error';
            }
            delete activeXhrs[id];
        }
    };
    const fd = new FormData();
    // let server know current directory path (so single file upload from 'New' goes to current folder)
    fd.append('path', currentPath || '');
    fd.append('file', file, uploadName);
    xhr.open('POST', '/upload', true);
    xhr.send(fd);
}
function formatBytes(bytes){ if(!bytes && bytes!==0) return ''; const sizes=['B','KB','MB','GB','TB']; if(bytes===0) return '0 B'; const i=Math.floor(Math.log(bytes)/Math.log(1024)); return Math.round(bytes/Math.pow(1024,i)) + ' ' + sizes[i]; }

/* ---------- Create folder ---------- */
function createFolder(){
    const name = prompt('Folder name:');
    if(!name) return;
    const fd = new FormData(); fd.append('folder_name', name); fd.append('path', currentPath || '');
    fetch('/create_folder', {method:'POST', body:fd}).then(r=>r.json()).then(j=>{
        if(j.success) location.reload(); else alert('Error: ' + (j.error || 'unknown'));
    });
}

/* ---------- Download helper ---------- */
function downloadFile(path){ window.location.href = '/download/' + encodeURIComponent(path); }

/* ---------- Context menu (right-click) ---------- */
document.querySelectorAll('.file-row').forEach(row=>{
    row.addEventListener('contextmenu', e=>{
        e.preventDefault();
        const name = row.dataset.name;
        const type = row.dataset.type;
        const path = row.dataset.path || '';
        currentItem = {name, type, path};
        showContext(e.clientX, e.clientY, type);
    });
});
function showContext(x,y,type){
    document.getElementById('ctx-preview').style.display = (type === 'Folder') ? 'none' : 'block';
    ctx.style.left = x + 'px'; ctx.style.top = y + 'px'; ctx.style.display = 'block';
}
window.addEventListener('click', ()=> ctx.style.display='none');
window.addEventListener('scroll', ()=> ctx.style.display='none');

document.getElementById('ctx-preview').addEventListener('click', ()=>{
    if(!currentItem) return;
    const p = (currentItem.path ? currentItem.path + '/' : '') + currentItem.name;
    window.location.href = '/preview/' + encodeURIComponent(p);
});
document.getElementById('ctx-rename').addEventListener('click', ()=>{
    if(!currentItem) return;
    document.getElementById('rename-input').value = currentItem.name;
    openModal('rename-modal');
});
document.getElementById('ctx-delete').addEventListener('click', ()=>{
    if(!currentItem) return;
    if(!confirm(`Move "${currentItem.name}" to trash?`)) return;
    const p = (currentItem.path ? currentItem.path + '/' : '') + currentItem.name;
    fetch('/trash/' + encodeURIComponent(p), {method:'POST'}).then(r=>r.json()).then(j=>{ if(j.success) location.reload(); else alert('Error: '+(j.error||'unknown')); });
});
document.getElementById('ctx-info').addEventListener('click', ()=>{
    if(!currentItem) return;
    const p = (currentItem.path ? currentItem.path + '/' : '') + currentItem.name;
    fetch('/info/' + encodeURIComponent(p)).then(r=>r.json()).then(j=>{
        if(j.success){
            document.getElementById('info-body').innerHTML = `<div><strong>Name:</strong> ${j.name}</div><div><strong>Type:</strong> ${j.type}</div><div><strong>Size:</strong> ${j.size}</div><div><strong>Created:</strong> ${j.created||''}</div><div><strong>Modified:</strong> ${j.modified||''}</div>`;
            openModal('info-modal');
        } else alert('Error: '+(j.error||'unknown'));
    });
});
document.getElementById('ctx-copy').addEventListener('click', ()=>{
    if(!currentItem) return;
    const dest = prompt('Copy to folder (relative to uploads/, leave empty for root):', '');
    if(dest === null) return;
    const src = (currentItem.path ? currentItem.path + '/' : '') + currentItem.name;
    const fd = new FormData(); fd.append('src', src); fd.append('dest', dest);
    fetch('/copy', {method:'POST', body:fd}).then(r=>r.json()).then(j=>{ if(j.success) location.reload(); else alert('Error: '+(j.error||'unknown')); });
});
document.getElementById('ctx-move').addEventListener('click', ()=>{
    if(!currentItem) return;
    const dest = prompt('Move to folder (relative to uploads/, leave empty for root):', '');
    if(dest === null) return;
    const src = (currentItem.path ? currentItem.path + '/' : '') + currentItem.name;
    const fd = new FormData(); fd.append('src', src); fd.append('dest', dest);
    fetch('/move', {method:'POST', body:fd}).then(r=>r.json()).then(j=>{ if(j.success) location.reload(); else alert('Error: '+(j.error||'unknown')); });
});

/* ---------- Rename modal ---------- */
function openModal(id){ document.getElementById(id).style.display='flex'; document.getElementById(id).setAttribute('aria-hidden','false'); }
function closeModal(id){ document.getElementById(id).style.display='none'; document.getElementById(id).setAttribute('aria-hidden','true'); }
function doRename(){
    const newName = document.getElementById('rename-input').value.trim();
    if(!currentItem || !newName) return alert('Enter new name');
    const src = (currentItem.path ? currentItem.path + '/' : '') + currentItem.name;
    const fd = new FormData(); fd.append('new_name', newName);
    fetch('/rename/' + encodeURIComponent(src), {method:'POST', body:fd}).then(r=>r.json()).then(j=>{ if(j.success){ closeModal('rename-modal'); location.reload(); } else alert('Error: '+(j.error||'unknown')); });
}

/* ---------- openTrash ---------- */
function openTrash(){ alert('Trash view not implemented in this demo'); }
</script>
</body>
</html>